<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <button id="login">login github</button>
    <script>
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            //console.log('Query variable %s not found', variable);
        }
        const toHexString = (byteArray) => {
            return Array.prototype.map.call(byteArray, (byte) => {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join('');
        }
        const genRandomStr = () => {
            return toHexString(window.crypto.getRandomValues(new Uint32Array(10)));
        }

        (() => {
            const codeValue = getQueryVariable("code");
            const fromChild = getQueryVariable("fromChild");
            if (codeValue && !fromChild) {
                window.opener.location.href = window.location.href + '&fromChild=1';
                window.close();
            } else if (codeValue && fromChild) {
                const state = getQueryVariable("state");
                if (localStorage.getItem('oauth_state') !== state) {
                    alert('YOU LOSE');
                    return;
                }
                const myHeaders = new Headers();
                myHeaders.append("x-cors-lol", "coucou");
                fetch("https://nktpluginscommit.azurewebsites.net/api/githuboauth?code=" + codeValue, {
                    method: "GET",
                    mode: "cors",
                    headers: myHeaders
                })
                    .then(response => response.json())
                    .then(json => localStorage.setItem("github_token", json["access_token"]))
                    .catch(() => console.log("erro when fetching token"));
            } else {
                const state = genRandomStr();
                localStorage.setItem('oauth_state', state);
                document.getElementById('login').addEventListener('click', () => {
                    const clientId = "766e6d2f7f359b73cef3";
                    window.open(
                        "https://github.com/login/oauth/authorize?client_id="
                        + clientId
                        + "&scope=repo&redirect_uri=https%3A%2F%2Ffabiendaou.github.io%2Findex.html&login=fabienDaou&state="
                        + state,
                        '_blank'
                    );
                });
            }
        })();

        const loadPlugins = async () => {
            const toNameAndUrl = (entry, private) => {
                return { name: entry.name, url: entry.url, isPrivate: private };
            };

            const publicResponse = await fetch("https://api.github.com/repos/fabienDaou/Nkt-plugins/contents/plugins", { method: "GET" });
            const publicJson = await publicResponse.json();
            const plugins = publicJson.map(plugin => toNameAndUrl(plugin, false));

            const fetchPluginTextHeaders = new Headers();
            const accessToken = localStorage.getItem("github_token");
            if (accessToken) {
                fetchPluginTextHeaders.append("authorization", `token ${accessToken}`);

                const headers = new Headers();
                headers.append("authorization", `token ${accessToken}`);
                headers.append("content-type", "application/json");

                const privateResponse = await fetch("https://api.github.com/repos/fabienDaou/Nkt-plugins-private/contents/plugins", { method: "GET", headers: headers });
                const privateJson = await privateResponse.json();
                plugins.concat(privateJson.map(plugin => toNameAndUrl(plugin, true)));
            }

            return await Promise.all(plugins.map(plugin => {
                const { name, isPrivate, url } = plugin;
                const jsonPromise = fetch(url, { headers: fetchPluginTextHeaders }).then(response => response.json());
                return new Promise((resolve, reject) => {
                    jsonPromise.then(text => resolve({ name, isPrivate, text })).catch(reason => reject(reason));
                });
            }));
        };

        const allowedParentOrigin = "https://nkt.herokuapp.com";

        (async () => {

            const plugins = await loadPlugins();
            parent.postMessage(JSON.stringify({ event: "pluginsLoaded", data: plugins }), allowedParentOrigin);
        })();

        window.addEventListener("message", event => {
            if (event.origin !== allowedParentOrigin) return;
            let action;
            let data;
            try {
                const eventData = JSON.parse(event.data);
                action = eventData.action;
                data = eventData.data;
            } catch {
                console.log("Invalid object.");
            }

            const accessToken = localStorage.getItem("github_token");
            const baseUri = "https://nktpluginscommit.azurewebsites.net/api";

            const { name, isPrivate } = data;
            const queryString = `?name=${encodeURIComponent(name)}&isPrivate=${encodeURIComponent(isPrivate)}&accessToken=${encodeURIComponent(accessToken)}`;

            switch (action) {
                case "commit": // expecting data looking like { name: "pluginName", isPrivate: true, text: "" }
                    const { text } = data;

                    const headers = new Headers();
                    headers.append("content-type", "application/javascript");

                    fetch(`${baseUri}/commit${queryString}`, { method: "POST", body: text, headers: headers })
                        .then(response => console.log(response.status))
                        .catch(reason => console.log(reason));
                    break;
                case "delete": // expecting data looking like { name: "pluginName", isPrivate: true }

                    fetch(`${baseUri}/delete${queryString}`, { method: "DELETE" })
                        .then(response => console.log(response.status))
                        .catch(reason => console.log(reason));
                    break;
                default:
                    console.log("Invalid action: " + action);
            }
        });
    </script>
</body>

</html>