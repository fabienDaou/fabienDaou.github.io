<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <button id="login">github login</button>
    <script>
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            //console.log('Query variable %s not found', variable);
        }

        const toHexString = (byteArray) => {
            return Array.prototype.map.call(byteArray, (byte) => {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join('');
        };

        const genRandomStr = () => {
            return toHexString(window.crypto.getRandomValues(new Uint32Array(10)));
        };

        const getAccessToken = () => {
            return localStorage.getItem("github_token");
        };

        const appendAuthorizationHeader = headers => {
            const accessToken = getAccessToken();
            headers.append("authorization", `token ${accessToken}`);
        };

        const allowedParentOrigin = "https://nkt.herokuapp.com";
        const postEvent = (eventName, data) => parent.postMessage(JSON.stringify({ event: eventName, data: data }), allowedParentOrigin);

        (() => {
            const codeValue = getQueryVariable("code");
            const fromChild = getQueryVariable("fromChild");
            const token = getAccessToken();
            if (codeValue && !fromChild) {
                window.opener.location.href = window.location.href + '&fromChild=1';
                window.close();
            } else if (codeValue && fromChild) {
                const state = getQueryVariable("state");
                if (localStorage.getItem('oauth_state') !== state) {
                    alert('YOU LOSE');
                    return;
                }
                const myHeaders = new Headers();
                myHeaders.append("x-cors-lol", "coucou");
                fetch("https://nktpluginscommit.azurewebsites.net/api/githuboauth?code=" + codeValue, {
                    method: "GET",
                    mode: "cors",
                    headers: myHeaders
                })
                    .then(response => response.json())
                    .then(json => {
                        localStorage.setItem("github_token", json["access_token"]);
                        window.location.href = '/index.html';
                    })
                    .catch(() => console.log("erro when fetching token"));
            } else if (!token) {
                const state = genRandomStr();
                localStorage.setItem('oauth_state', state);
                document.getElementById('login').addEventListener('click', () => {
                    const clientId = "766e6d2f7f359b73cef3";
                    window.open(
                        "https://github.com/login/oauth/authorize?client_id="
                        + clientId
                        + "&scope=repo&redirect_uri=https%3A%2F%2Ffabiendaou.github.io%2Findex.html&login=fabienDaou&state="
                        + state,
                        '_blank'
                    );
                });
            } else {
                const button = document.getElementById('login');
                button.textContent = 'github logout';
                document.getElementById('login').addEventListener('click', () => {
                    window.localStorage.removeItem('github_token');
                    window.location.href = '/index.html';
                });
            }
        })();

        const loadPlugins = async () => {
            const toPluginInfo = (entry, private) => {
                return { name: entry.name, sha: entry.sha, url: entry.url, isPrivate: private };
            };

            const filterGitKeep = name => name !== ".gitkeep";

            const loadOneRepository = async (owner, name, isPrivate) => {
                const headers = new Headers();
                appendAuthorizationHeader(headers);
                const response = await fetch(`https://api.github.com/repos/${owner}/${name}/contents/plugins`, { method: "GET", headers: headers });
                if (response.status === 200) {
                    const json = await response.json();
                    return json.filter(({ name }) => filterGitKeep(name)).map(plugin => toPluginInfo(plugin, isPrivate));
                } else {
                    console.error(`Could not load plugins from ${owner}/${name} because ${response.statusText}.`);
                    return [];
                }
            };

            if (getAccessToken()) {
                const publicPlugins = await loadOneRepository("fabienDaou", "Nkt-plugins", false);
                const privatePlugins = await loadOneRepository("fabienDaou", "Nkt-plugins-private", true);
                const allPlugins = publicPlugins.concat(privatePlugins);

                const fetchPluginTextHeaders = new Headers();
                appendAuthorizationHeader(fetchPluginTextHeaders);
                fetchPluginTextHeaders.append("Accept", "application/vnd.github.v4.raw");
                return await Promise.all(allPlugins.map(plugin => {
                    const { name, sha, isPrivate, url } = plugin;
                    const textPromise = fetch(url, { headers: fetchPluginTextHeaders }).then(response => response.text());
                    return new Promise((resolve, reject) => {
                        textPromise.then(text => resolve({ name, sha, isPrivate, text })).catch(reason => reject(reason));
                    });
                }));
            } else {
                // Because of rate limit for unauthenticated request, we need to use a proxy azure function that will use a personal access token.
                const response = await fetch("https://nktpluginscommit.azurewebsites.net/api/getAll");
                const json = await response.json();
                let publicPlugins = [];
                for (let repositoryIndex = 0; repositoryIndex < json.length; repositoryIndex++) {
                    const { isPrivate, plugins } = json[repositoryIndex];
                    publicPlugins = publicPlugins.concat(plugins.filter(({ name }) => filterGitKeep(name)).map(({ name, sha, text }) => { return { name, sha, isPrivate, text }; }));
                }
                return publicPlugins;
            }
        };

        (async () => {
            const codeValue = getQueryVariable("code");
            const fromChild = getQueryVariable("fromChild");
            if (codeValue || fromChild) return;
            const plugins = await loadPlugins();
            postEvent("pluginsLoaded", plugins);
        })();
    </script>
    <script src="postMessageHook.js" type="text/javascript"></script>
</body>

</html>