<!DOCTYPE html>
<html>

<head>
</head>

<body>
    <button id="login">login github</button>
    <script>
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            //console.log('Query variable %s not found', variable);
        }
        const toHexString = (byteArray) => {
            return Array.prototype.map.call(byteArray, (byte) => {
                return ('0' + (byte & 0xFF).toString(16)).slice(-2);
            }).join('');
        }
        const genRandomStr = () => {
            return toHexString(window.crypto.getRandomValues(new Uint32Array(10)));
        }

        (() => {
            const codeValue = getQueryVariable("code");
            const fromChild = getQueryVariable("fromChild");
            if (codeValue && !fromChild) {
                window.opener.location.href = window.location.href + '&fromChild=1';
                window.close();
            } else if (codeValue && fromChild) {
                const state = getQueryVariable("state");
                if (localStorage.getItem('oauth_state') !== state) {
                    alert('YOU LOSE');
                    return;
                }
                const myHeaders = new Headers();
                myHeaders.append("x-cors-lol", "coucou");
                fetch("https://nktpluginscommit.azurewebsites.net/api/githuboauth?code=" + codeValue, {
                    method: "GET",
                    mode: "cors",
                    headers: myHeaders
                })
                    .then(response => response.json())
                    .then(json => localStorage.setItem("github_token", json["access_token"]))
                    .catch(() => console.log("erro when fetching token"));
            } else {
                const state = genRandomStr();
                localStorage.setItem('oauth_state', state);
                document.getElementById('login').addEventListener('click', () => {
                    const clientId = "766e6d2f7f359b73cef3";
                    window.open(
                        "https://github.com/login/oauth/authorize?client_id="
                        + clientId
                        + "&scope=repo&redirect_uri=https%3A%2F%2Ffabiendaou.github.io%2Findex.html&login=fabienDaou&state="
                        + state,
                        '_blank'
                    );
                });
            }
        })();

        const loadPlugins = async () => {
            const accessToken = localStorage.getItem("github_token");
            const headers = new Headers();
            headers.append("authorization", `token ${accessToken}`);

            const jsonResponse = await fetch(`https://api.github.com/graphql`,
                {
                    method: "POST",
                    body: 
                    { 
                        query: "query GetPlugins { search(first: 3, query: \"Nkt-plugins\", type: REPOSITORY) { edges { node { ... on Repository { name isPrivate object(expression: \"master:plugins\") { ... on Tree { entries { name object { ... on Tree { entries { name } } ... on Blob { text } } } } } } } } } }" 
                    },
                    headers: headers
                }).json();

            return jsonResponse.data.search.edges.filter(({ node }) => node.object !== null).map(({ node }) => {
                return {
                    name: node.name,
                    isPrivate: node.isPrivate,
                    plugins: node.object.entries.map(({ name, object }) => {
                        return { name, text: object.text };
                    })
                };
            });

        };
        const plugins = await loadPlugins();
        parent.postMessage(JSON.stringify({ event: "pluginsLoaded", data: plugins }), "https://nkt.herokuapp.com");
    </script>
</body>

</html>